"use strict";var e=require("./httpRequest-79d7914f.js");function t(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}for(var r=t(require("crypto")),n=function(t){return function(r){return function(n){return e.__awaiter(void 0,void 0,void 0,(function(){return e.__generator(this,(function(e){return[2,t.retryStrategy.retry(r,n)]}))}))}}},o={name:"retryMiddleware",tags:["RETRY"],step:"finalizeRequest",priority:"high"},a=["AuthFailure","InvalidSignatureException","RequestExpired","RequestInTheFuture","RequestTimeTooSkewed","SignatureDoesNotMatch"],i=["Throttling","ThrottlingException","ThrottledException","RequestThrottledException","TooManyRequestsException","ProvisionedThroughputExceededException","TransactionInProgressException","RequestLimitExceeded","BandwidthLimitExceeded","LimitExceededException","RequestThrottled","SlowDown","PriorRequestNotComplete","EC2ThrottledException"],u=["AbortError","TimeoutError","RequestTimeout","RequestTimeoutException"],s=[500,502,503,504],c=function(e){var t;return i.includes(e.name)||1==(null===(t=e.$retryable)||void 0===t?void 0:t.throttling)},d=function(){return r.default.randomBytes(16)},l=[],f=0;f<256;++f)l[f]=(f+256).toString(16).substr(1);var v,p,m=function(e,t){var r=t||0,n=l;return[n[e[r++]],n[e[r++]],n[e[r++]],n[e[r++]],"-",n[e[r++]],n[e[r++]],"-",n[e[r++]],n[e[r++]],"-",n[e[r++]],n[e[r++]],"-",n[e[r++]],n[e[r++]],n[e[r++]],n[e[r++]],n[e[r++]],n[e[r++]]].join("")},y=0,T=0;var h=function(e,t,r){var n=t&&r||0,o=t||[],a=(e=e||{}).node||v,i=void 0!==e.clockseq?e.clockseq:p;if(null==a||null==i){var u=d();null==a&&(a=v=[1|u[0],u[1],u[2],u[3],u[4],u[5]]),null==i&&(i=p=16383&(u[6]<<8|u[7]))}var s=void 0!==e.msecs?e.msecs:(new Date).getTime(),c=void 0!==e.nsecs?e.nsecs:T+1,l=s-y+(c-T)/1e4;if(l<0&&void 0===e.clockseq&&(i=i+1&16383),(l<0||s>y)&&void 0===e.nsecs&&(c=0),c>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");y=s,T=c,p=i;var f=(1e4*(268435455&(s+=122192928e5))+c)%4294967296;o[n++]=f>>>24&255,o[n++]=f>>>16&255,o[n++]=f>>>8&255,o[n++]=255&f;var h=s/4294967296*1e4&268435455;o[n++]=h>>>8&255,o[n++]=255&h,o[n++]=h>>>24&15|16,o[n++]=h>>>16&255,o[n++]=i>>>8|128,o[n++]=255&i;for(var _=0;_<6;++_)o[n+_]=a[_];return t||m(o)};var _=function(e,t,r){var n=t&&r||0;"string"==typeof e&&(t="binary"===e?new Array(16):null,e=null);var o=(e=e||{}).random||(e.rng||d)();if(o[6]=15&o[6]|64,o[8]=63&o[8]|128,t)for(var a=0;a<16;++a)t[n+a]=o[a];return t||m(o)},E=_;E.v1=h,E.v4=_;var R=E,x=function(e,t){return Math.floor(Math.min(2e4,Math.random()*Math.pow(2,t)*e))},g=function(e){return!!e&&(function(e){return void 0!==e.$retryable}(e)||function(e){return a.includes(e.name)}(e)||c(e)||function(e){var t;return u.includes(e.name)||s.includes((null===(t=e.$metadata)||void 0===t?void 0:t.httpStatusCode)||0)}(e))},M=function(){function t(e,t){var r,n,o,a,i,u,s,c;this.maxAttemptsProvider=e,this.retryDecider=null!==(r=null==t?void 0:t.retryDecider)&&void 0!==r?r:g,this.delayDecider=null!==(n=null==t?void 0:t.delayDecider)&&void 0!==n?n:x,this.retryQuota=null!==(o=null==t?void 0:t.retryQuota)&&void 0!==o?o:(i=a=500,u=a,s=function(e){return"TimeoutError"===e.name?10:5},c=function(e){return s(e)<=u},Object.freeze({hasRetryTokens:c,retrieveRetryTokens:function(e){if(!c(e))throw new Error("No retry token available");var t=s(e);return u-=t,t},releaseRetryTokens:function(e){u+=null!=e?e:1,u=Math.min(u,i)}}))}return t.prototype.shouldRetry=function(e,t,r){return t<r&&this.retryDecider(e)&&this.retryQuota.hasRetryTokens(e)},t.prototype.getMaxAttempts=function(){return e.__awaiter(this,void 0,void 0,(function(){var t;return e.__generator(this,(function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,this.maxAttemptsProvider()];case 1:return t=e.sent(),[3,3];case 2:return e.sent(),t=3,[3,3];case 3:return[2,t]}}))}))},t.prototype.retry=function(t,r){return e.__awaiter(this,void 0,void 0,(function(){var n,o,a,i,u,s,d,l;return e.__generator(this,(function(f){switch(f.label){case 0:return o=0,a=0,[4,this.getMaxAttempts()];case 1:i=f.sent(),u=r.request,e.HttpRequest.isInstance(u)&&(u.headers["amz-sdk-invocation-id"]=R.v4()),s=function(){var s,l,f,v,p;return e.__generator(this,(function(m){switch(m.label){case 0:return m.trys.push([0,2,,5]),e.HttpRequest.isInstance(u)&&(u.headers["amz-sdk-request"]="attempt="+(o+1)+"; max="+i),[4,t(r)];case 1:return s=m.sent(),l=s.response,f=s.output,d.retryQuota.releaseRetryTokens(n),f.$metadata.attempts=o+1,f.$metadata.totalRetryDelay=a,[2,{value:{response:l,output:f}}];case 2:return v=m.sent(),o++,d.shouldRetry(v,o,i)?(n=d.retryQuota.retrieveRetryTokens(v),p=d.delayDecider(c(v)?500:100,o),a+=p,[4,new Promise((function(e){return setTimeout(e,p)}))]):[3,4];case 3:return m.sent(),[2,"continue"];case 4:throw v.$metadata||(v.$metadata={}),v.$metadata.attempts=o,v.$metadata.totalRetryDelay=a,v;case 5:return[2]}}))},d=this,f.label=2;case 2:return[5,s()];case 3:return"object"==typeof(l=f.sent())?[2,l.value]:[3,2];case 4:return[2]}}))}))},t}(),A={environmentVariableSelector:function(e){var t=e.AWS_MAX_ATTEMPTS;if(t){var r=parseInt(t);if(Number.isNaN(r))throw new Error('Environment variable AWS_MAX_ATTEMPTS mast be a number, got "'+t+'"');return r}},configFileSelector:function(e){var t=e.max_attempts;if(t){var r=parseInt(t);if(Number.isNaN(r))throw new Error('Shared config file entry max_attempts mast be a number, got "'+t+'"');return r}},default:3},S=function(e){if(void 0===e&&(e=3),"number"==typeof e){var t=Promise.resolve(e);return function(){return t}}return e},w={environmentVariableSelector:function(e){return e.AWS_RETRY_MODE},configFileSelector:function(e){return e.retry_mode},default:"standard"};exports.CONFIG_MAX_ATTEMPTS="max_attempts",exports.CONFIG_RETRY_MODE="retry_mode",exports.DEFAULT_MAX_ATTEMPTS=3,exports.DEFAULT_RETRY_MODE="standard",exports.ENV_MAX_ATTEMPTS="AWS_MAX_ATTEMPTS",exports.ENV_RETRY_MODE="AWS_RETRY_MODE",exports.NODE_MAX_ATTEMPT_CONFIG_OPTIONS=A,exports.NODE_RETRY_MODE_CONFIG_OPTIONS=w,exports.StandardRetryStrategy=M,exports.defaultDelayDecider=x,exports.defaultRetryDecider=g,exports.getRetryPlugin=function(e){return{applyToStack:function(t){t.add(n(e),o)}}},exports.resolveRetryConfig=function(t){var r=S(t.maxAttempts);return e.__assign(e.__assign({},t),{maxAttempts:r,retryStrategy:t.retryStrategy||new M(r)})},exports.retryMiddleware=n,exports.retryMiddlewareOptions=o;
